{% extends "frontend/base.html" %}
{% load static %}

{% block title %}
    {% if radar %}Edit Radar #{{ radar.id }}{% else %}Add New Radar{% endif %} - Radar Management System
{% endblock %}

{% block content %}
<div class="radar-form-container", style = "margin: 16px;">
    <h1>{% if radar %}Edit Radar #{{ radar.id }}{% else %}Add New Radar{% endif %}</h1>
    
    <form method="post" id="radar-form">
        {% csrf_token %}
        
        <fieldset class="module aligned">
            <h2>Radar Information</h2>
            
            <div class="form-row">
                <div>
                    <label for="{{ form.type.id_for_label }}" class="required">Radar Type:</label>
                    {{ form.type }}
                    {% if form.type.errors %}
                        <ul class="errorlist">
                            {% for error in form.type.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            </div>
            
            <div style ="margin-top: 15px; margin-left: 15px; margin-right: 15px;">
                <div>
                    <label for="id_search">Search Location:</label>
                    <input type="text" id="location-search" placeholder="Search for a place..." style="width: 100%; padding: 8px;">
                    <small style="color: #666;">Search for a location to center the map</small>
                </div>
            </div>
        </fieldset>
        
        <fieldset class="module aligned">
            <h2>Detection Area</h2>
            <p style="color: #666; margin-bottom: 15px;">
                Use the map below to define the radar's detection area. Click to start drawing a polygon.
            </p>
            
            <div id="map" class="map-container"></div>
            
            <div class="polygon-info" id="polygon-info" style="display: none;">
                <h4>Detection Area Info:</h4>
                <p id="polygon-coords"></p>
                <p id="polygon-center"></p>
            </div>
            
            <!-- Hidden fields for storing polygon data -->
            {% if not settings.HAS_GIS %}
            <div style="display: none;">
                <label for="{{ form.sector_json.id_for_label }}">Sector JSON:</label>
                {{ form.sector_json }}
                <label for="{{ form.center_lat.id_for_label }}">Center Latitude:</label>
                {{ form.center_lat }}
                <label for="{{ form.center_lon.id_for_label }}">Center Longitude:</label>
                {{ form.center_lon }}
            </div>
            {% else %}
            <div style="display: none;">
                {{ form.sector }}
                {{ form.center }}
            </div>
            {% endif %}
        </fieldset>
        
        <fieldset class="module aligned">
            <h2>Traffic Details</h2>
            
            <div class="form-row">
                <div>
                    <label for="{{ form.speed_limit.id_for_label }}">Speed Limit (km/h):</label>
                    {{ form.speed_limit }}
                    {% if form.speed_limit.errors %}
                        <ul class="errorlist">
                            {% for error in form.speed_limit.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label for="{{ form.direction.id_for_label }}">Direction:</label>
                    {{ form.direction }}
                    {% if form.direction.errors %}
                        <ul class="errorlist">
                            {% for error in form.direction.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label for="{{ form.notes.id_for_label }}">Notes:</label>
                    {{ form.notes }}
                    {% if form.notes.errors %}
                        <ul class="errorlist">
                            {% for error in form.notes.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            </div>
        </fieldset>
        
        <div class="submit-row">
            <input type="submit" value="{% if radar %}Update{% else %}Save{% endif %} Radar" class="default btn btn-primary">
            <a href="{% url 'frontend:radar_list' %}" class="btn btn-secondary">Cancel</a>
            {% if radar %}
            <a href="{% url 'frontend:radar_delete' radar.id %}" class="btn btn-danger" 
               onclick="return confirm('Are you sure you want to delete this radar?')" style="float: right;">Delete Radar</a>
            {% endif %}
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Pass Django template data to JavaScript
const radarData = {
    hasGIS: {% if settings.HAS_GIS %}true{% else %}false{% endif %},
    isEditing: {% if radar %}true{% else %}false{% endif %},
    {% if not settings.HAS_GIS %}
    sectorJsonId: '{{ form.sector_json.id_for_label }}',
    centerLatId: '{{ form.center_lat.id_for_label }}',
    centerLonId: '{{ form.center_lon.id_for_label }}',
    {% endif %}
    {% if radar and radar.sector_json %}
    sectorJson: {{ radar.sector_json|safe }}
    {% else %}
    sectorJson: null
    {% endif %}
};
</script>
<!-- MapLibre + Draw CSS/JS (lightweight CDNs). These are added here so the radar form
     always has the mapping and drawing libraries available. If your base template already
     includes these, they will simply be duplicated (safe but can be optimized later). -->
<link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
<link href="https://unpkg.com/@mapbox/mapbox-gl-draw/dist/mapbox-gl-draw.css" rel="stylesheet" />
<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/@mapbox/mapbox-gl-draw/dist/mapbox-gl-draw.js"></script>

<!-- Small inline map styles and the pick-location control styling -->
<style>
    /* Ensure the map has visible height */
    #map.map-container { height: 480px; width: 100%; margin-bottom: 10px; }

    /* Floating pick-location button inside the map */
    .map-control-btn {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 2;
        background: white;
        border: 1px solid rgba(0,0,0,0.1);
        padding: 6px 8px;
        border-radius: 4px;
        cursor: pointer;
        box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        font-size: 14px;
    }
    .map-control-btn.active { background: #007bff; color: white; }

    /* Simple search results box positioning fallback */
    #search-results { position: absolute; z-index: 3; left: 0; right: 0; background: white; border: 1px solid #ddd; max-height: 260px; overflow: auto; }
</style>
<script src="{% static 'frontend/js/radar_form.js' %}"></script>
{% endblock %}